{% extends "administracion/dashboard_users.html" %}
{% load staticfiles %}
{% block dashboard_body %}

	<form id="parentForm" method="post" action="" data-parsley-validate="" enctype="multipart/form-data" class="form-horizontal form-label-left" novalidate="">

        {% csrf_token %}

        {% for hidden in form.hidden_fields %}
            {{ hidden }}
        {% endfor %}
		
		<div>
        	<h3>{{ seccion }}</h3>
		</div>

		{% for subseccion in data %}
			
			<h2>{{subseccion.nombre}}</h2>

			{% for pregunta in subseccion.preguntas %}
				
				<h4>{{pregunta.texto}}</h4>
				
				<div id="question-container-{{pregunta.id}}" class='question-container'>
					{% for respuesta in pregunta.respuestas %}
						
						
						<div class='form-container'>

							{% for field in respuesta.form.visible_fields %}
                            
                        
	                            <div class="item form-group">

	                                <div class="col-md-6 col-sm-6 col-xs-12">
	                                    <div class="col-sm-12">
	                                       <p>{{ field }}</p>
	                                    </div>
	                                </div>
									
									<div class="col-xs-12 col-sm-12 col-md-3 col-lg-3">
										<a id="delete-for-{{respuesta.id}}" class="btn btn-danger delete-answer" href="javascript:void(0)">-</a>
									</div>

	                            </div>

	                            {{ field.errors }}


                    		{% endfor %}
						
						</div>
						
					

					{% endfor%}
				</div>
				
				<a id="answer-for-{{pregunta.id}}" class="btn btn-success add-answer" href="javascript:void(0)">
					+
				</a>
				
			
			{% endfor %}
		
		{% endfor %}

        <div class="form-group">
            <div class="col-md-6 col-sm-6 col-xs-12 col-md-offset-3">
                
                <button type="submit" class="btn btn-success">Dale</button>
            </div>
        </div>

    </form>

    <style>
    	
    	.add-answer {
    		margin-top: 10px;
    	}

    </style>

{% endblock %}


{% block extra_js %}
		
<script>

	$.ajaxSetup({ 
	     beforeSend: function(xhr, settings) {
	         function getCookie(name) {
	             var cookieValue = null;
	             if (document.cookie && document.cookie != '') {
	                 var cookies = document.cookie.split(';');
	                 for (var i = 0; i < cookies.length; i++) {
	                     var cookie = jQuery.trim(cookies[i]);
	                     // Does this cookie string begin with the name we want?
	                     if (cookie.substring(0, name.length + 1) == (name + '=')) {
	                         cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
	                         break;
	                     }
	                 }
	             }
	             return cookieValue;
	         }
	         if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
	             // Only send the token to relative URLs i.e. locally.
	             xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
	         }
	     } 
	});

	function append_anwser(id_question, response) {
		
		var id = $(response).attr('id').replace(/\D/g,'');
		console.log(id);

		var div = '<div class="form-container"><div class="item form-group"><div class="col-md-6 col-sm-6 col-xs-12"><div class="col-sm-12"><p>';
		
		div += response;
		div += '</p></div></div><div class="col-xs-12 col-sm-12 col-md-3 col-lg-3"><a id="delete-for-' 
		div += id + '"';
		div += ' class="btn btn-danger delete-answer" href="javascript:void(0)">-</a></div></div></div>'

		$("#question-container-" + id_question).append(div);
	}



	$('.add-answer').click(function() {
		var id_study = {{id_estudio}};
		var id_question = $(this).attr('id').replace(/\D/g,'');



		$.ajax({
			url : "{% url 'captura:agregar_respuesta_estudio' %}",

			method : "POST",

			data : {"id_estudio" : id_study, "id_pregunta" : id_question},

			success : function(response) {
				append_anwser(id_question, response)
			},

			error : function(response) {
				alert(response);
			}
		});
	});

	$(document).on('click', '.delete-answer', (function() {
		var sender_button = $(this);
		var id_respuesta = sender_button.attr('id').replace(/\D/g,'');
		
		$.ajax({
			url : "{% url 'captura:quitar_respuesta_estudio' %}",

			method : "POST",

			data : {"id_respuesta" : id_respuesta},

			success : function(response) {
				sender_button.closest("div.form-container").remove()
			},

			error : function(response) {

			}
		});

	}));

</script>

{% endblock %}